```{r, echo=FALSE}
knitr::opts_chunk$set(fig.pos = "H", out.extra = "", echo = FALSE,
                      warning = FALSE, message = FALSE)
```

```{r}
# Preparation

# Read in all years of data
library(data.table)
library(survey)
library(ggplot2)
library(scales)
library(knitr)
library(kableExtra)
library(weights)
source(paste0(getwd(), "/_RCode/read_census_data.R"))
source(paste0(getwd(), "/_RCode/make_table_data.R"))
source(paste0(getwd(), "/_RCode/make_plot_data.R"))
source(paste0(getwd(), "/_RCode/additional_functions.R"))

#Color palette (discrete): c("#EA008B", "#554149", "#BDA5AD", "#A07200", "#694200")

#Color palette (ordinal): c("#EA008B", "#FF416f", "#FF7457", "#FFA349", "#FFCF50", "#F9F871")
```


# Demographics and social characteristics {#sociodemo}

## Burning Man Attendence

### Propotion of Virgins
```{r, echo = FALSE}
virgin <- makePlotData(varName = "Virgin", varNameTable,
                          designs = list(design13, design14, design15, 
                                         design16, design17, design18, 
                                         design19, design22),
                          years = c(2013:2019, 2022), 
                          levels = list(c("no", "yes"), c("no", "yes"),
                                        c("no", "yes"), c("no", "yes"),
                                        c("no", "yes"), c("no", "yes"),
                                        c("no", "yes"), c(FALSE, TRUE)),
                          labels = c("Not Virgin", "Virgin"),
                          labelOrder = c("Virgin", "Not Virgin"))


ggplot(virgin[virgin$labels == "Virgin",], aes(x = year, y = est)) +
  geom_line(linewidth = 1.5, color = "#EA008B") +
  geom_point(size = 2.25, color = "black") +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2,
                linewidth = 1.25) +
  theme_bw(13) +
  theme(panel.grid.minor = element_blank()) +
  # scale_color_brewer(type = "seq", palette = 11) +
  scale_x_continuous(breaks = c(2013:2019, 2022), labels = c(2013:2019, 2022)) +
  scale_y_continuous(labels = percent) +
  labs(x = "Year", y = "Percent of Burners at BRC in 2022")

#An annoying thing happens when subsetting to one row.  The table class turns
#  into a character vector.  Happy to take suggestions on a better way to do
#  this.
virginTable <- makeTableData(virgin, confInt = "plusminus")
virginTable <- virginTable[2,] |>
  matrix(nrow = 1) |>
  as.table()
rownames(virginTable) = "Virgin"
colnames(virginTable) = c(2013:2019, 2022)
virginTable |>
  kbl() |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```



### Number of burns attended

```{r, echo = FALSE, warning = FALSE}
ggplot(census22, aes(x = numberBurns, y = after_stat(density), weight = weights)) + 
  geom_histogram(fill = "#EA008B", color = "black") +
  theme_bw() +
  labs(x = "Number of burns attended (including 2022)", y = "Density")

medianBurns <- c(svyquantile(~numberBurns, design22, 0.5)[[1]][1],
                 svyquantile(~nbburns, design19, 0.5)[[1]][1],
                 svyquantile(~nbburns, design18, 0.5)[[1]][1],
                 svyquantile(~nbburns, design17, 0.5)[[1]][1],
                 svyquantile(~nbburns, design16, 0.5)[[1]][1],
                 svyquantile(~nbburns, design15, 0.5)[[1]][1],
                 svyquantile(~nbburns, design14, 0.5)[[1]][1],
                 1) |>
  rev() |>
  matrix(nrow = 1)
row.names(medianBurns) <- "Median Prior Burns Attended"
medianBurns |>
  kbl(col.names = c(2013:2019, 2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```

<!-- Other ideas?  Average number of burns attended without a break? -->



## Demographics

### Age
```{r, echo = FALSE, warning = FALSE}
ggplot(census22, aes(x = age, y = after_stat(density), weight = weights)) + 
  geom_histogram(fill = "#EA008B", color = "black") +
  theme_bw() +
  labs(x = "Age when arriving on playa in 2022", y = "Density")

medianAge <- c(svyquantile(~age, design22, 0.5)[[1]][1],
                 svyquantile(~age, design19, 0.5)[[1]][1],
                 svyquantile(~age, design18, 0.5)[[1]][1],
                 svyquantile(~age, design17, 0.5)[[1]][1],
                 svyquantile(~age, design16, 0.5)[[1]][1],
                 svyquantile(~age, design15, 0.5)[[1]][1],
                 svyquantile(~age, design14, 0.5)[[1]][1],
                 32) |>
  rev() |>
  matrix(nrow = 1)
row.names(medianAge) <- "Median Age"
medianAge |>
  kbl(col.names = c(2013:2019, 2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```


### Current gender
```{r, echo = FALSE, warning = FALSE}
gender22.male <- svyciprop(~grepl("(?<!([Ff]e))[Mm]ale", currentGender, perl = TRUE), 
                           design22)
gender22.male <- data.table(est = as.numeric(gender22.male), 
                            lower = attr(gender22.male, "ci")[1],
                            upper = attr(gender22.male, "ci")[2],
                            level = "male",
                            year = 2022,
                            labels = factor("Male", 
                                            levels = c("Male", "Female", 
                                                       "Other identity")))
gender22.female <- svyciprop(~grepl("[Ff]emale", currentGender, perl = TRUE), 
                           design22)
gender22.female <- data.table(est = as.numeric(gender22.female), 
                            lower = attr(gender22.female, "ci")[1],
                            upper = attr(gender22.female, "ci")[2],
                            level = "female",
                            year = 2022,
                            labels = factor("Female", 
                                            levels = c("Male", "Female", 
                                                       "Other identity")))
gender22.other <- svyciprop(~I(!grepl("[Mm]ale", currentGender, perl = TRUE)), 
                           design22)
gender22.other <- data.table(est = as.numeric(gender22.other), 
                            lower = attr(gender22.other, "ci")[1],
                            upper = attr(gender22.other, "ci")[2],
                            level = "male",
                            year = 2022,
                            labels = factor("Other identity", 
                                            levels = c("Male", "Female", 
                                                       "Other identity")))
gender22 <- rbind(gender22.male, gender22.female, gender22.other)

gender <- makePlotData(varName = "What is your current gender?", varNameTable,
                          designs = list(design13, design14, design15, 
                                         design16, design17, design18, 
                                         design19),
                          years = c(2013:2019), 
                          levels = list(c("female", "fluid", "male"), 
                                        c("female", "fluid", "male"), 
                                        c("female", "fluid", "male"),  
                                        c("female", "fluid", "male"),
                                        c("female", "fluid", "male"), 
                                        c("female", "fluid", "male"), 
                                        c("female", "fluid", "male")),
                          labels = c("Female", "Other identity", "Male"),
                          labelOrder = c("Male", "Female", "Other identity"))
gender <- rbind(gender, gender22)

ggplot(gender, aes(x = year, y = est, color = labels)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 2.25, color = "black") +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2,
                linewidth = 1) +
  theme_bw(13) +
  theme(panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(2013:2019, 2022), labels = c(2013:2019, 2022)) +
  scale_y_continuous(labels = percent) +
  scale_color_manual(values = c("#EA008B", "#554149", "#BDA5AD")) +
  labs(x = "Year", y = "", 
       color = "Current gender")

makeTableData(gender) |>
  kbl(col.names = c(2013:2019, 2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")

```


### Sex assigned at birth
```{r}
sexAtBirth <- makePlotData(varName = "What sex was assigned to you at birth?", 
                           varNameTable,
                           designs = list(design22),
                           years = c(2022), 
                           levels = list(c("Female", "Intersex", "Male")),
                           labels = c("Female", "Intersex", "Male"),
                           labelOrder = rev(c("Male", "Female", "Intersex")))

ggplot(sexAtBirth, aes(x = labels, y = est)) +
  geom_bar(stat = "identity", fill = "#EA008B") +
  scale_y_continuous(labels = percent) +
  labs(x = "Sex at birth", y = "") +
  theme_bw() +
  coord_flip()

sexAtBirthTable <- rev(makeTableData(sexAtBirth) )
sexAtBirthTableNames <- names(sexAtBirthTable)
sexAtBirthTable <- matrix(sexAtBirthTable, ncol = 1)
rownames(sexAtBirthTable) <- sexAtBirthTableNames
sexAtBirthTable |>
  kbl(col.names = c(2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```


### Gender identity
```{r}
genderID <- makePlotData(varName = "What is your current gender?", varNameTable,
                            designs = list(design22),
                          years = c(2022), 
                          levels = list(c("Female", "Male", "Gender queer", 
                                          "Cisgender male", "Cisgender female",
                                          "Transgender female/Trans female",
                                          "Non-binary",
                                          "Transgender male/ Trans male",
                                          "Prefer to self-describe",
                                          "Two-spirit")),
                          labels = c("Female", "Male", "Gender queer", 
                                     "Cisgender male", "Cisgender female",
                                     "Transgender female", "Non-binary", 
                                     "Transgender male", "Other", "Two-spirit"),
                          labelOrder = rev(c("Male", "Female", "Cisgender male",
                                             "Cisgender female", 
                                             "Transgender female", "Non-binary",
                                             "Gender queer", "Transgender male", 
                                             "Other", "Two-spirit")))

ggplot(genderID, aes(x = labels, y = est)) +
  geom_bar(stat = "identity", fill = "#EA008B") +
  scale_y_continuous(labels = percent) +
  labs(x = "Gender identity", y = "") +
  theme_bw() +
  coord_flip()

genderIDTable <- rev(makeTableData(genderID) )
genderIDTableNames <- names(genderIDTable)
genderIDTable <- matrix(genderIDTable, ncol = 1)
rownames(genderIDTable) <- genderIDTableNames
genderIDTable |>
  kbl(col.names = c(2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```


<!--  Do you consider yourself to be any of the following (transperson etc.) -->


### Chosen pronouns

```{r}
pronouns <- makePlotData(varName = "What are your pronouns?", varNameTable,
                         designs = list(design22),
                         years = c(2022), 
                         levels = list(c(TRUE)),
                         labels = c("She/her", "They/them", "He/him", "Other"),
                         labelOrder = c("He/him", "She/her", "They/them", 
                                         "Other"))

ggplot(pronouns, aes(x = labels, y = est)) +
  geom_bar(stat = "identity", fill = "#EA008B") +
  scale_y_continuous(labels = percent) +
  labs(x = "Gender identity", y = "") +
  theme_bw()

makeTableData(pronouns) |>
  kbl(col.names = c(2022), row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```

### Personal income in 2021
```{r}
pi.lt25.22 <- customPlotDat(c("No income", "Less than $7500", 
                                 "$7,500-$14,999", "$15,000-$24,999"),
                               design = design22, "personalIncome",
                               2022, "Less than $25,000")
pi.25to50.22 <- customPlotDat(c("$25,000-$34,999", "$35,000-$49,999"),
                              design = design22, "personalIncome", 2022,
                              "$25,000-$49,999")
pi.50to100.22 <- customPlotDat(c("$50,000-$74,999", "$75,000-$99,999"),
                               design = design22, "personalIncome",
                               2022, "$50,000-$99,999")
pi.100to300.22 <- customPlotDat(c("$100,000-$149,999", "$150,000-$299,000"),
                                design = design22, "personalIncome", 2022,
                                "$100,000-$299,999")
pi.gt300.22 <- customPlotDat("$300,000 or more", design = design22,
                             "personalIncome", 2022, "$300,000 or more")
pi.22 <- rbind(pi.lt25.22, pi.25to50.22, pi.50to100.22, pi.100to300.22,
               pi.gt300.22)

pi.lt25.19 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design19, "incomep",
                               2019, "Less than $25,000")
pi.25to50.19 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design19, "incomep", 2019,
                              "$25,000-$49,999")
pi.50to100.19 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design19, "incomep",
                               2019, "$50,000-$99,999")
pi.100to300.19 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design19, "incomep", 2019,
                                "$100,000-$299,999")
pi.gt300.19 <- customPlotDat("_300kUS_or_more", design = design19,
                             "incomep", 2019, "$300,000 or more")
pi.19 <- rbind(pi.lt25.19, pi.25to50.19, pi.50to100.19, pi.100to300.19,
               pi.gt300.19)

pi.lt25.18 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design18, "incomep",
                               2018, "Less than $25,000")
pi.25to50.18 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design18, "incomep", 2018,
                              "$25,000-$49,999")
pi.50to100.18 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design18, "incomep",
                               2018, "$50,000-$99,999")
pi.100to300.18 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design18, "incomep", 2018,
                                "$100,000-$299,999")
pi.gt300.18 <- customPlotDat("_300kUS_or_more", design = design18,
                             "incomep", 2018, "$300,000 or more")
pi.18 <- rbind(pi.lt25.18, pi.25to50.18, pi.50to100.18, pi.100to300.18,
               pi.gt300.18)

pi.lt25.17 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design17, "incomep",
                               2017, "Less than $25,000")
pi.25to50.17 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design17, "incomep", 2017,
                              "$25,000-$49,999")
pi.50to100.17 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design17, "incomep",
                               2017, "$50,000-$99,999")
pi.100to300.17 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design17, "incomep", 2017,
                                "$100,000-$299,999")
pi.gt300.17 <- customPlotDat("_300kUS_or_more", design = design17,
                             "incomep", 2017, "$300,000 or more")
pi.17 <- rbind(pi.lt25.17, pi.25to50.17, pi.50to100.17, pi.100to300.17,
               pi.gt300.17)

pi.lt25.16 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design16, "incomep",
                               2016, "Less than $25,000")
pi.25to50.16 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design16, "incomep", 2016,
                              "$25,000-$49,999")
pi.50to100.16 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design16, "incomep",
                               2016, "$50,000-$99,999")
pi.100to300.16 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design16, "incomep", 2016,
                                "$100,000-$299,999")
pi.gt300.16 <- customPlotDat("_300kUS_or_more", design = design16,
                             "incomep", 2016, "$300,000 or more")
pi.16 <- rbind(pi.lt25.16, pi.25to50.16, pi.50to100.16, pi.100to300.16,
               pi.gt300.16)

pi.lt25.15 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design15, "incomep",
                               2015, "Less than $25,000")
pi.25to50.15 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design15, "incomep", 2015,
                              "$25,000-$49,999")
pi.50to100.15 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design15, "incomep",
                               2015, "$50,000-$99,999")
pi.100to300.15 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design15, "incomep", 2015,
                                "$100,000-$299,999")
pi.gt300.15 <- customPlotDat("_300kUS_or_more", design = design15,
                             "incomep", 2015, "$300,000 or more")
pi.15 <- rbind(pi.lt25.15, pi.25to50.15, pi.50to100.15, pi.100to300.15,
               pi.gt300.15)

pi.allYears <- rbind(pi.22, pi.19, pi.18, pi.17, pi.16, pi.15)
pi.allYears$labels <- factor(pi.allYears$labels, 
                             levels = c("Less than $25,000",
                                        "$25,000-$49,999",
                                        "$50,000-$99,999",
                                        "$100,000-$299,999",
                                        "$300,000 or more"))

ggplot(pi.allYears, aes(x = year, y = est, color = labels)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 2.25, color = "black") +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2,
                linewidth = 1) +
  theme_bw(13) +
  theme(panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(2013:2019, 2022), labels = c(2013:2019, 2022)) +
  scale_y_continuous(labels = percent) +
  scale_color_manual(values = c("#EA008B", "#FF416f", "#FF7457", "#FFA349", 
                                "#FFCF50")) +
  labs(x = "Year", y = "", color = "Personal income (USD)")

personalIncome <- makePlotData(varName = "What was your personal income in 2021 before taxes? Give your best estimate. Please do not include your spouse's income as your own.", 
                         varNameTable,
                         designs = list(design15, design16, design17, design18,
                                        design19, design22),
                         years = c(2015:2019, 2022), 
                         levels = c(rep(list(c("_100k_149999US", 
                                               "_15000_24999US", 
                                               "_150k_299999US", 
                                               "_25000_34999US",  
                                               "_300kUS_or_more", 
                                               "_35000_49999US", 
                                               "_50000_74999US", 
                                               "_7500_14999US", 
                                               "_75000_99999US", 
                                               "Less_than_7500US", 
                                               "None")), times  = 5),
                                    list(c("$100,000-$149,999", "$15,000-$24,999", 
                                    "$150,000-$299,000", "$25,000-$34,999",
                                    "$300,000 or more", "$35,000-$49,999",
                                    "$50,000-$74,999", "$7,500-$14,999",
                                    "$75,000-$99,999", "Less than $7500",
                                    "No income"))),
                         labels = c("$100,000-$149,999", "$15,000-$24,999", 
                                    "$150,000-$299,000", "$25,000-$34,999",
                                    "$300,000 or more", "$35,000-$49,999",
                                    "$50,000-$74,999", "$7,500-$14,999",
                                    "$75,000-$99,999", "Less than $7,500",
                                    "No income"),
                         labelOrder = c("No income", "Less than $7,500", 
                                        "$7,500-$14,999", "$15,000-$24,999", 
                                        "$25,000-$34,999", "$35,000-$49,999",
                                        "$50,000-$74,999", "$75,000-$99,999",
                                        "$100,000-$149,999", "$150,000-$299,000",
                                        "$300,000 or more"))

# simValues <- apply(personalIncome, 1, function(x){
#   simVs <- ifelse(x[6] == "No income", rep(0, times = round(1000 * as.numeric(x[1]))),
#            ifelse(x[6] == "Less than $7,500", runif(round(1000 * as.numeric(x[1])), 1, 7499),
#            ifelse(x[6] == "$7,500-$14,999", runif(round(1000 * as.numeric(x[1])), 7500, 14999),
#            ifelse(x[6] == "$15,000-$24,999", runif(round(1000 * as.numeric(x[1])), 15000, 24999),
#            ifelse(x[6] == "$25,000-$34,999", runif(round(1000 * as.numeric(x[1])), 25000, 34999),
#            ifelse(x[6] == "$35,000-$49,999", runif(round(1000 * as.numeric(x[1])), 35000, 49999),
#            ifelse(x[6] == "$50,000-$74,999", runif(round(1000 * as.numeric(x[1])), 50000, 74999),
#            ifelse(x[6] == "$75,000-$99,999", runif(round(1000 * as.numeric(x[1])), 75000, 99999),
#            ifelse(x[6] == "$100,000-$149,999", runif(round(1000 * as.numeric(x[1])), 100000, 149999),
#            ifelse(x[6] == "$150,000-$299,999", runif(round(1000 * as.numeric(x[1])), 150000, 299999),
#                   rbeta(round(1000 * as.numeric(x[1])), 1, 3) * 700000 + 300000))))))))))
#   data.frame(simValues = simVs, year = as.numeric(x[5]))
# })
# simValues <- do.call(rbind, simValues)  
# ggplot(simValues, aes(x = year, y = simValues, group = year)) +
#   geom_violin()

makeTableData(personalIncome) |>
  kbl(col.names = c(2015:2019, 2022), row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```


### Household income in 2021
```{r}
hi.lt25.22 <- customPlotDat(c("No income", "Less than $7500", 
                                 "$7,500-$14,999", "$15,000-$24,999"),
                               design = design22, "householdIncome",
                               2022, "Less than $25,000")
hi.25to50.22 <- customPlotDat(c("$25,000-$34,999", "$35,000-$49,999"),
                              design = design22, "householdIncome", 2022,
                              "$25,000-$49,999")
hi.50to100.22 <- customPlotDat(c("$50,000-$74,999", "$75,000-$99,999"),
                               design = design22, "householdIncome",
                               2022, "$50,000-$99,999")
hi.100to300.22 <- customPlotDat(c("$100,000-$149,999", "$150,000-$299,000"),
                                design = design22, "householdIncome", 2022,
                                "$100,000-$299,999")
hi.gt300.22 <- customPlotDat("$300,000 or more", design = design22,
                             "householdIncome", 2022, "$300,000 or more")
hi.22 <- rbind(hi.lt25.22, hi.25to50.22, hi.50to100.22, hi.100to300.22,
               hi.gt300.22)

hi.lt25.19 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design19, "incomeh",
                               2019, "Less than $25,000")
hi.25to50.19 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design19, "incomeh", 2019,
                              "$25,000-$49,999")
hi.50to100.19 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design19, "incomeh",
                               2019, "$50,000-$99,999")
hi.100to300.19 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design19, "incomeh", 2019,
                                "$100,000-$299,999")
hi.gt300.19 <- customPlotDat("_300kUS_or_more", design = design19,
                             "incomeh", 2019, "$300,000 or more")
hi.19 <- rbind(hi.lt25.19, hi.25to50.19, hi.50to100.19, hi.100to300.19,
               hi.gt300.19)

hi.lt25.18 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design18, "incomeh",
                               2018, "Less than $25,000")
hi.25to50.18 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design18, "incomeh", 2018,
                              "$25,000-$49,999")
hi.50to100.18 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design18, "incomeh",
                               2018, "$50,000-$99,999")
hi.100to300.18 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design18, "incomeh", 2018,
                                "$100,000-$299,999")
hi.gt300.18 <- customPlotDat("_300kUS_or_more", design = design18,
                             "incomeh", 2018, "$300,000 or more")
hi.18 <- rbind(hi.lt25.18, hi.25to50.18, hi.50to100.18, hi.100to300.18,
               hi.gt300.18)

hi.lt25.17 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design17, "incomeh",
                               2017, "Less than $25,000")
hi.25to50.17 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design17, "incomeh", 2017,
                              "$25,000-$49,999")
hi.50to100.17 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design17, "incomeh",
                               2017, "$50,000-$99,999")
hi.100to300.17 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design17, "incomeh", 2017,
                                "$100,000-$299,999")
hi.gt300.17 <- customPlotDat("_300kUS_or_more", design = design17,
                             "incomeh", 2017, "$300,000 or more")
hi.17 <- rbind(hi.lt25.17, hi.25to50.17, hi.50to100.17, hi.100to300.17,
               hi.gt300.17)

hi.lt25.16 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design16, "incomeh",
                               2016, "Less than $25,000")
hi.25to50.16 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design16, "incomeh", 2016,
                              "$25,000-$49,999")
hi.50to100.16 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design16, "incomeh",
                               2016, "$50,000-$99,999")
hi.100to300.16 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design16, "incomeh", 2016,
                                "$100,000-$299,999")
hi.gt300.16 <- customPlotDat("_300kUS_or_more", design = design16,
                             "incomeh", 2016, "$300,000 or more")
hi.16 <- rbind(hi.lt25.16, hi.25to50.16, hi.50to100.16, hi.100to300.16,
               hi.gt300.16)

hi.lt25.15 <- customPlotDat(c("None", "Less_than_7500US", 
                                 "_7500_14999US", "_15000_24999US"),
                               design = design15, "incomeh",
                               2015, "Less than $25,000")
hi.25to50.15 <- customPlotDat(c("_25000_34999US", "_35000_49999US"),
                              design = design15, "incomeh", 2015,
                              "$25,000-$49,999")
hi.50to100.15 <- customPlotDat(c("_50000_74999US", "_75000_99999US"),
                               design = design15, "incomeh",
                               2015, "$50,000-$99,999")
hi.100to300.15 <- customPlotDat(c("_100k_149999US", "_150k_299999US"),
                                design = design15, "incomeh", 2015,
                                "$100,000-$299,999")
hi.gt300.15 <- customPlotDat("_300kUS_or_more", design = design15,
                             "incomeh", 2015, "$300,000 or more")
hi.15 <- rbind(hi.lt25.15, hi.25to50.15, hi.50to100.15, hi.100to300.15,
               hi.gt300.15)

hi.allYears <- rbind(hi.22, hi.19, hi.18, hi.17, hi.16, hi.15)
hi.allYears$labels <- factor(hi.allYears$labels, 
                             levels = c("Less than $25,000",
                                        "$25,000-$49,999",
                                        "$50,000-$99,999",
                                        "$100,000-$299,999",
                                        "$300,000 or more"))

ggplot(hi.allYears, aes(x = year, y = est, color = labels)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 2.25, color = "black") +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2,
                linewidth = 1) +
  theme_bw(13) +
  theme(panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(2013:2019, 2022), labels = c(2013:2019, 2022)) +
  scale_y_continuous(labels = percent) +
  scale_color_manual(values = c("#EA008B", "#FF416f", "#FF7457", "#FFA349", 
                                "#FFCF50")) +
  labs(x = "Year", y = "", color = "Personal income (USD)")

householdIncome <- makePlotData(varName = "What was the total income before taxes of all members of your household (including you) in 2021?", 
                         varNameTable,
                         designs = list(design15, design16, design17, design18,
                                        design19, design22),
                         years = c(2015:2019, 2022), 
                         levels = c(rep(list(c("_100k_149999US", 
                                               "_15000_24999US", 
                                               "_150k_299999US", 
                                               "_25000_34999US",  
                                               "_300kUS_or_more", 
                                               "_35000_49999US", 
                                               "_50000_74999US", 
                                               "_7500_14999US", 
                                               "_75000_99999US", 
                                               "Less_than_7500US", 
                                               "None")), times  = 5),
                                    list(c("$100,000-$149,999", "$15,000-$24,999", 
                                    "$150,000-$299,000", "$25,000-$34,999",
                                    "$300,000 or more", "$35,000-$49,999",
                                    "$50,000-$74,999", "$7,500-$14,999",
                                    "$75,000-$99,999", "Less than $7500",
                                    "No income"))),
                         labels = c("$100,000-$149,999", "$15,000-$24,999", 
                                    "$150,000-$299,000", "$25,000-$34,999",
                                    "$300,000 or more", "$35,000-$49,999",
                                    "$50,000-$74,999", "$7,500-$14,999",
                                    "$75,000-$99,999", "Less than $7,500",
                                    "No income"),
                         labelOrder = c("No income", "Less than $7,500", 
                                        "$7,500-$14,999", "$15,000-$24,999", 
                                        "$25,000-$34,999", "$35,000-$49,999",
                                        "$50,000-$74,999", "$75,000-$99,999",
                                        "$100,000-$149,999", "$150,000-$299,000",
                                        "$300,000 or more"))

# simValues <- apply(personalIncome, 1, function(x){
#   simVs <- ifelse(x[6] == "No income", rep(0, times = round(1000 * as.numeric(x[1]))),
#            ifelse(x[6] == "Less than $7,500", runif(round(1000 * as.numeric(x[1])), 1, 7499),
#            ifelse(x[6] == "$7,500-$14,999", runif(round(1000 * as.numeric(x[1])), 7500, 14999),
#            ifelse(x[6] == "$15,000-$24,999", runif(round(1000 * as.numeric(x[1])), 15000, 24999),
#            ifelse(x[6] == "$25,000-$34,999", runif(round(1000 * as.numeric(x[1])), 25000, 34999),
#            ifelse(x[6] == "$35,000-$49,999", runif(round(1000 * as.numeric(x[1])), 35000, 49999),
#            ifelse(x[6] == "$50,000-$74,999", runif(round(1000 * as.numeric(x[1])), 50000, 74999),
#            ifelse(x[6] == "$75,000-$99,999", runif(round(1000 * as.numeric(x[1])), 75000, 99999),
#            ifelse(x[6] == "$100,000-$149,999", runif(round(1000 * as.numeric(x[1])), 100000, 149999),
#            ifelse(x[6] == "$150,000-$299,999", runif(round(1000 * as.numeric(x[1])), 150000, 299999),
#                   rbeta(round(1000 * as.numeric(x[1])), 1, 3) * 700000 + 300000))))))))))
#   data.frame(simValues = simVs, year = as.numeric(x[5]))
# })
# simValues <- do.call(rbind, simValues)  
# ggplot(simValues, aes(x = year, y = simValues, group = year)) +
#   geom_violin()

makeTableData(householdIncome) |>
  kbl(col.names = c(2015:2019, 2022), row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```

### Highest level of education completed

<!-- need to create 2022 variable for highest level completed to compare to prior years -->

```{r}
education <- makePlotData(varName = "Which level of education have you completed?",
                          varNameTable,
                          designs = list(design22),
                          years = c(2022), 
                          levels = c(TRUE),
                          labels = c("High school diploma \n or equivalent",
                                     "Some college",
                                     "Associate's degree",
                                     "Bachelor's degree",
                                     "Graduate degree (Master's, \n Doctorate, or equivalent)",
                                     "Technical/vocational \n certification",
                                     "Other",
                                     "None of these"),
                          labelOrder = c("High school diploma \n or equivalent",
                                         "Some college",
                                         "Associate's degree",
                                         "Bachelor's degree",
                                         "Graduate degree (Master's, \n Doctorate, or equivalent)",
                                         "Technical/vocational \n certification",
                                         "Other",
                                         "None of these"))

ggplot(education, aes(x = labels, y = est)) +
  geom_bar(stat = "identity", fill = "#EA008B") +
  scale_y_continuous(labels = percent) +
  labs(x = "Level of education competed", y = "") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

makeTableData(education) |>
  kbl(col.names = c(2022), row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```

<!-- ## Residence -->

<!-- ### Residence inside of Black Rock City -->


<!-- ### Residence outside of Black Rock City -->


<!-- ### California and Nevada County Residence -->

<!-- <!-- ZIP Code converted to county and maybe smoothed --> 

<!-- ### State residence -->

<!-- <!-- ZIP code converted to state --> 

<!-- ### Canadian province residence -->

<!-- <!-- Postal code converted to province --> 

## Voting and politics

### Number of times voted in last four Federal US elections 

<!-- Combine with voting eligiblity -->



### Political party affiliation



### Political views



## Ethinicity and language

### Ethnoracial background



### Person of Color



### First language learned


## Spirituality

### Spirituality



### Religion or religious denomination

<!-- Something needs to be done to address the multiple religions selection, not sure what -->

## Disabilities

### Identify with a disability status

<!-- Maybe separate into binary yes/no and categories if yes? -->


## Sexuality

### Sexual orientation



### Sexuality labels



## Relationships

### Romantic Orientation



### Partner in the default world



### Relationship labels