```{r, echo=FALSE}
knitr::opts_chunk$set(fig.pos = "H", out.extra = "", echo = FALSE,
                      warning = FALSE, message = FALSE)
```

```{r}
# Preparation

# Read in all years of data
library(data.table)
library(survey)
library(ggplot2)
library(scales)
library(knitr)
library(kableExtra)
library(weights)
source(paste0(getwd(), "/_RCode/read_census_data.R"))
source(paste0(getwd(), "/_RCode/make_table_data.R"))
source(paste0(getwd(), "/_RCode/make_plot_data.R"))
source(paste0(getwd(), "/_RCode/additional_functions.R"))
```


# Demographics and social characteristics {#sociodemo}

## Burning Man Attendence

### Propotion of Virgins
```{r, echo = FALSE}
virgin <- makePlotData(varName = "Virgin", varNameTable,
                          designs = list(design13, design14, design15, 
                                         design16, design17, design18, 
                                         design19, design22),
                          years = c(2013:2019, 2022), 
                          levels = list(c("no", "yes"), c("no", "yes"),
                                        c("no", "yes"), c("no", "yes"),
                                        c("no", "yes"), c("no", "yes"),
                                        c("no", "yes"), c(FALSE, TRUE)),
                          labels = c("Not Virgin", "Virgin"),
                          labelOrder = c("Virgin", "Not Virgin"))


ggplot(virgin[virgin$labels == "Virgin",], aes(x = year, y = est)) +
  geom_line(linewidth = 1.5, color = "#EA008B") +
  geom_point(size = 2.25, color = "black") +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2,
                linewidth = 1.25) +
  theme_bw(13) +
  theme(panel.grid.minor = element_blank()) +
  # scale_color_brewer(type = "seq", palette = 11) +
  scale_x_continuous(breaks = c(2013:2019, 2022), labels = c(2013:2019, 2022)) +
  scale_y_continuous(labels = percent) +
  labs(x = "Year", y = "Percent of Burners at BRC in 2022")

#An annoying thing happens when subsetting to one row.  The table class turns
#  into a character vector.  Happy to take suggestions on a better way to do
#  this.
virginTable <- makeTableData(virgin, confInt = "plusminus")
virginTable <- virginTable[2,] |>
  matrix(nrow = 1) |>
  as.table()
rownames(virginTable) = "Virgin"
colnames(virginTable) = c(2013:2019, 2022)
virginTable |>
  kbl() |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```



### Number of burns attended

```{r, echo = FALSE, warning = FALSE}
ggplot(census22, aes(x = numberBurns, y = after_stat(density), weight = weights)) + 
  geom_histogram(fill = "#EA008B", color = "black") +
  theme_bw() +
  labs(x = "Number of burns attended (including 2022)", y = "Density")

medianBurns <- c(svyquantile(~numberBurns, design22, 0.5)[[1]][1],
                 svyquantile(~nbburns, design19, 0.5)[[1]][1],
                 svyquantile(~nbburns, design18, 0.5)[[1]][1],
                 svyquantile(~nbburns, design17, 0.5)[[1]][1],
                 svyquantile(~nbburns, design16, 0.5)[[1]][1],
                 svyquantile(~nbburns, design15, 0.5)[[1]][1],
                 svyquantile(~nbburns, design14, 0.5)[[1]][1],
                 1) |>
  rev() |>
  matrix(nrow = 1)
row.names(medianBurns) <- "Median Prior Burns Attended"
medianBurns |>
  kbl(col.names = c(2013:2019, 2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```

<!-- Other ideas?  Average number of burns attended without a break? -->



## Demographics

### Age
```{r, echo = FALSE, warning = FALSE}
ggplot(census22, aes(x = age, y = after_stat(density), weight = weights)) + 
  geom_histogram(fill = "#EA008B", color = "black") +
  theme_bw() +
  labs(x = "Age when arriving on playa in 2022", y = "Density")

medianAge <- c(svyquantile(~age, design22, 0.5)[[1]][1],
                 svyquantile(~age, design19, 0.5)[[1]][1],
                 svyquantile(~age, design18, 0.5)[[1]][1],
                 svyquantile(~age, design17, 0.5)[[1]][1],
                 svyquantile(~age, design16, 0.5)[[1]][1],
                 svyquantile(~age, design15, 0.5)[[1]][1],
                 svyquantile(~age, design14, 0.5)[[1]][1],
                 32) |>
  rev() |>
  matrix(nrow = 1)
row.names(medianAge) <- "Median Age"
medianAge |>
  kbl(col.names = c(2013:2019, 2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```


### Current gender
```{r, echo = FALSE, warning = FALSE}
gender22.male <- svyciprop(~grepl("(?<!([Ff]e))[Mm]ale", currentGender, perl = TRUE), 
                           design22)
gender22.male <- data.table(est = as.numeric(gender22.male), 
                            lower = attr(gender22.male, "ci")[1],
                            upper = attr(gender22.male, "ci")[2],
                            level = "male",
                            year = 2022,
                            labels = factor("Male", 
                                            levels = c("Male", "Female", 
                                                       "Other identity")))
gender22.female <- svyciprop(~grepl("[Ff]emale", currentGender, perl = TRUE), 
                           design22)
gender22.female <- data.table(est = as.numeric(gender22.female), 
                            lower = attr(gender22.female, "ci")[1],
                            upper = attr(gender22.female, "ci")[2],
                            level = "female",
                            year = 2022,
                            labels = factor("Female", 
                                            levels = c("Male", "Female", 
                                                       "Other identity")))
gender22.other <- svyciprop(~I(!grepl("[Mm]ale", currentGender, perl = TRUE)), 
                           design22)
gender22.other <- data.table(est = as.numeric(gender22.other), 
                            lower = attr(gender22.other, "ci")[1],
                            upper = attr(gender22.other, "ci")[2],
                            level = "male",
                            year = 2022,
                            labels = factor("Other identity", 
                                            levels = c("Male", "Female", 
                                                       "Other identity")))
gender22 <- rbind(gender22.male, gender22.female, gender22.other)

gender <- makePlotData(varName = "What is your current gender?", varNameTable,
                          designs = list(design13, design14, design15, 
                                         design16, design17, design18, 
                                         design19),
                          years = c(2013:2019), 
                          levels = list(c("female", "fluid", "male"), 
                                        c("female", "fluid", "male"), 
                                        c("female", "fluid", "male"),  
                                        c("female", "fluid", "male"),
                                        c("female", "fluid", "male"), 
                                        c("female", "fluid", "male"), 
                                        c("female", "fluid", "male")),
                          labels = c("Female", "Other identity", "Male"),
                          labelOrder = c("Male", "Female", "Other identity"))
gender <- rbind(gender, gender22)

ggplot(gender, aes(x = year, y = est, color = labels)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 2.25, color = "black") +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2,
                linewidth = 1) +
  theme_bw(13) +
  theme(panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(2013:2019, 2022), labels = c(2013:2019, 2022)) +
  scale_y_continuous(labels = percent) +
  scale_color_manual(values = c("#EA008B", "#554149", "#BDA5AD")) +
  labs(x = "Year", y = "", 
       color = "Current gender")

makeTableData(gender) |>
  kbl(col.names = c(2013:2019, 2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")

```


### Sex assigned at birth
```{r}
sexAtBirth <- makePlotData(varName = "What sex was assigned to you at birth?", 
                           varNameTable,
                           designs = list(design22),
                           years = c(2022), 
                           levels = list(c("Female", "Intersex", "Male")),
                           labels = c("Female", "Intersex", "Male"),
                           labelOrder = rev(c("Male", "Female", "Intersex")))

ggplot(sexAtBirth, aes(x = labels, y = est)) +
  geom_bar(stat = "identity", fill = "#EA008B") +
  scale_y_continuous(labels = percent) +
  labs(x = "Sex at birth", y = "") +
  theme_bw() +
  coord_flip()

sexAtBirthTable <- rev(makeTableData(sexAtBirth) )
sexAtBirthTableNames <- names(sexAtBirthTable)
sexAtBirthTable <- matrix(sexAtBirthTable, ncol = 1)
rownames(sexAtBirthTable) <- sexAtBirthTableNames
sexAtBirthTable |>
  kbl(col.names = c(2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```


### Gender identity
```{r}
genderID <- makePlotData(varName = "What is your current gender?", varNameTable,
                            designs = list(design22),
                          years = c(2022), 
                          levels = list(c("Female", "Male", "Gender queer", 
                                          "Cisgender male", "Cisgender female",
                                          "Transgender female/Trans female",
                                          "Non-binary",
                                          "Transgender male/ Trans male",
                                          "Prefer to self-describe",
                                          "Two-spirit")),
                          labels = c("Female", "Male", "Gender queer", 
                                     "Cisgender male", "Cisgender female",
                                     "Transgender female", "Non-binary", 
                                     "Transgender male", "Other", "Two-spirit"),
                          labelOrder = rev(c("Male", "Female", "Cisgender male",
                                             "Cisgender female", 
                                             "Transgender female", "Non-binary",
                                             "Gender queer", "Transgender male", 
                                             "Other", "Two-spirit")))

ggplot(genderID, aes(x = labels, y = est)) +
  geom_bar(stat = "identity", fill = "#EA008B") +
  scale_y_continuous(labels = percent) +
  labs(x = "Gender identity", y = "") +
  theme_bw() +
  coord_flip()

genderIDTable <- rev(makeTableData(genderID) )
genderIDTableNames <- names(genderIDTable)
genderIDTable <- matrix(genderIDTable, ncol = 1)
rownames(genderIDTable) <- genderIDTableNames
genderIDTable |>
  kbl(col.names = c(2022),
      row.names = TRUE) |>
  kable_paper("striped", full_width = F) |>
  kable_styling() |>
  scroll_box(width = "100%")
```


<!--  Do you consider yourself to be any of the following (transperson etc.) -->


### Preferred pronouns


### Personal income in 2021


### Household income in 2021


### Highest level of education completed


## Residence

### Residence inside of Black Rock City


### Residence outside of Black Rock City


### California and Nevada County Residence

<!-- ZIP Code converted to county and maybe smoothed -->

### State residence

<!-- ZIP code converted to state -->

### Canadian province residence

<!-- Postal code converted to province -->

## Voting and politics

### Number of times voted in last four Federal US elections 

<!-- Combine with voting eligiblity -->

### Political party affiliation



### Political views



## Ethinicity and language

### Ethnoracial background



### Person of Color



### First language learned


## Spirituality

### Spirituality



### Religion or religious denomination

<!-- Something needs to be done to address the multiple religions selection, not sure what -->

## Disabilities

### Identify with a disability status

<!-- Maybe separate into binary yes/no and categories if yes? -->


## Sexuality

### Sexual orientation



### Sexuality labels



## Relationships

### Romantic Orientation



### Partner in the default world



### Relationship labels